# Скрипт для парсинга последних 100 сообщений из ВК и ТГ, сбора информации ВК и ТГ каналах, а также выгрузки БД из Notion

## Подготовительные этапы
### Google Cloud Console и Google Sheets
* Создать сервисный аккаунт в Google Cloud Console. Полученный .json файл с ключом положить на уровень основного скрипта. Также сохранить сервисный email.
* В настройках Google Cloud Console в разделе APIs & Services включить доступ к Google Sheets API и Google Drive API	
* В файл .env в переменную CREDENTIALS_GOOGLE_FILE внести полное значение имени .json файла с ключами (пример: ft-vk-parser-38b40b1c4d73.json)
* В браузере зайти в Google аккаунт, перейти в Drive и создать новые файлы Google Таблиц (7 шт.:со ссылками для парсинга, выгрузка постов из ВК, выгрузка постов из ТГ, выгрузка инфо по каналам ВК, выгрузка инфо по каналам ТГ, выгрузка данных из основной таблицы Notion, выгрузка данных из Notion БД со ссылками).
* Убедиться, что первая страница во всех файлах называется "Лист1"
* В первую строчку таблицы ввести названия заголовков: 
*  - Ссылки для парсинга: Ссылки для парсинга постов, Ссылки для парсинга каналов
*  - ВК парсинг постов: Группа, Пост, Текст оригинального поста, Дата-время, Лайки, Репосты, Комментарии, Просмотры, Текст репоста, Ссылка на оригинальный пост, Ссылка в посте
*  - ВК парсинг каналов: Канал, Дата-время, Количество подписчиков*  
*  - ТГ парсинг постов: Канал, Пост, Текст поста, Дата-время, Реакции, Комментарии, Просмотры, Количество репостов, Ссылка на оригинальный пост, Ссылка в посте
*  - ТГ парсинг каналов: Канал, Дата-время, Количество подписчиков
* Скопировать уникальный ID таблиц из адреса в браузере (например, в такой ссылке https://docs.google.com/spreadsheets/d/1mGn2hbiHoLilIYRNGWIQJyhR6DekxPHpgkX3wrVbK_g/edit?gid=0#gid=0 ID будет 1mGn2hbiHoLilIYRNGWIQJyhR6DekxPHpgkX3wrVbK_g) и сохранить ID таблицы в .env файле в переменные:
* - Ссылки для парсинга: ALL_LINKS_SPREADSHEET_ID
* - ВК парсинг постов: VK_POSTS_SPREADSHEET_ID
* - ВК парсинг каналов: VK_CHANNELS_SPREADSHEET_ID
* - ТГ парсинг постов: TG_POSTS_SPREADSHEET_ID
* - ТГ парсинг каналов: TG_CHANNELS_SPREADSHEET_ID
* - Notion основная БД: NOTION_TASKS_DB_ID
* - Notion основная БД: NOTION_URL_DB_ID
* В настройках доступа у каждой таблицы (кроме таблицы со ссылками) выдать доступ уровня "Редактор", указав сервисный email 

### VK Api
* Зайдя в VK аккаунт, перейти в раздел "Разработчикам"
* Создать приложение, от лица которого будет производиться парсинг
* Скопировать сервисный ключ приложения и сохранить его в .env в переменной VK_TOKEN

### TG Api
* Перейти на сайт https://my.telegram.org/auth
* Пройти процедуру авторизации
* Создать новое приложения
* Сохранить данные api_id и api_hash в соответствующие переменные файла .env (TG_API_ID и TG_API_HASH)

### Notion 
* Для работы парсера БД Notion необходима настройка прокси-сервера, т.к. Notion блокирует доступ к API из России. Данные подключения к прокси-серверу заносятся в файл .env (PROXY_LOGIN, PROXY_PASS, PROXY_IP, PROXY_PORT) 
* Собственник рабочего пространства должен создать интеграцию на сайте Notion (https://www.notion.com/my-integrations)
* Записать токен интеграции в файл .env в переменную NOTION_TOKEN
* Далее, также собственник рабочего пространства должен зайти на страницу базы данных и подключить к ней ранее созданную интеграцию (правый верхний угол -> знак троеточия -> connections)
* Занести ID баз данных в переменные в файле .env (NOTION_TASKS_DB_ID -> основная БД, NOTION_URL_DB_ID  -> БД со ссылками). Например, в такой ссылке https://www.notion.so/e93e6971eb884dc88e76a8dc3597b7fa?v=60e62a10ffc94b609ddf991400a86e03  ID -> e93e6971eb884dc88e76a8dc3597b7fa, т.е. после / и до ?

### Развертывание проекта на сервере
* Клонировать репозиторий через команду git clone 
* В терминале перейти в папку со скриптом командой cd 
* Создать и активировать виртуальное окружение: python3 -m venv venv, source venv/bin/activate. 
* Установить зависимости pip3 install -r requirements.txt
* Деактивировать виртуальное окружение deactivate
* В файл .env внести значение переменных VK_TOKEN, TG_API_ID, TG_API_HASH, PROXY_LOGIN 
* Создать файл и перенести данные из .json файла, содержащего ключи доступа к Google Api
* Внести задание на запуск скрипта в Cron через команду crontab -e. Пример команды: 0 8-20 * * 1-5 cd /home/ivan/Desktop/pythonProject && /home/ivan/Desktop/pythonProject/venv/bin/python3 main.py 

## Порядок работы
* Убедиться, что .json файл с доступами к Google Api находится в той же папке, что и основной файл main.py
* Внести адреса ссылок, по которым необходимо осуществить парсинг, в соответствующую Google Таблицу
* При первом запуске Telegram Api запросит пройти процедуру авторизации. Необходимо будет ввести в терминал номер телефона и код подтверждения, что придет на мобильном телефоне в приложении Telegram
* После успешной авторизации в папке проекта будет создан файл my_session.session. Он содержит все необходимые данные для повторной автоматической авторизации без необходимости ручного ввода кода подтверждения
* ВНИМАНИЕ! Файлы .env, .json и my_session.session содержат конфиденциальную информацию. Необходимо исключить их передачу третьим лицам.